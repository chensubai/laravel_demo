<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>用户中心</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="">
    <meta name="description" content="">
    <link rel="stylesheet" href="./public/css/bootstrap.min.css" media="screen" type="text/css">
    <link rel="stylesheet" href="./public/js/layui/css/layui.css">
    <link rel="stylesheet" href="./public/css/global.css">
    <link rel="stylesheet" href="./public/font/iconfont.css">
    <script src="./public/js/layui/layui.js"></script>
    <script src="./public/js/jquery-1.11.0.min.js"></script>
    <script src="./public/js/bootstrap.min.js"></script>
    <script src="./public/js/base.js"></script>
    <script>
        layui.config({
            base: './public/js/mods/'
        }).extend({
            fly: 'index'
        }).use('fly');
    </script>
</head>

<body class="body">
    <div class="fly-header layui-bg-black">
        <div class="layui-container">
            <a class="fly-logo" href="../cms/index.html">
                <img class="memeberlogo" src="./public/img/LOGO.png" alt="layui">
            </a>
            <ul class="layui-nav fly-nav-user" style="display: flex;align-items: center;">
                <!-- 登入后的状态 -->
                <li class="layui-nav-item">
                    <a class="fly-nav-avatar" href="javascript:;">
                        <img src="" id="avatar">
                        <cite><span id="username"></span></cite>
                    </a>
                    <dl class="layui-nav-child">
                        <dd><a href="../memeber/index.html"><i class="layui-icon">&#xe612;</i>マイページ</a></dd>
                        <dd><a href="../memeber/profile.html"><i class="layui-icon">&#xe620;</i>会員情報</a></dd>
                        <hr style="margin: 5px 0;">
                        <dd><a href="../memeber/login.html" style="text-align: center;">ログアウト</a></dd>
                    </dl>
                </li>
                <span class="layui-hide-xs" style="color: #000;">|</span>
                <span class="layui-hide-xs" style="color: #000;">日本 (日本語 / ¥ JPY)</span>
            </ul>
        </div>
    </div>
    <div>
        <div class="layui-container">
            <a class="fly-logo" href="../cms/index.html">
                ホームページx
            </a>
        </div>
    </div>
    <div class="layui-container fly-marginTop fly-user-main">
        <ul class="layui-nav layui-nav-tree layui-inline" lay-filter="user">
            <li class="layui-nav-item">
                <a href="../memeber/index.html"><i class="iconfont icon-people"></i>&nbsp;アカウント概要</a>
            </li>
            <li class="layui-nav-item">
                <a href="../memeber/shoporder.html"><i class="iconfont icon-oschina"></i>&nbsp;店頭履歴</a>
            </li>
            <li class="layui-nav-item">
                <a href="../memeber/order.html"><i class="iconfont icon-caigou"></i>&nbsp;郵送履歴</a>
            </li>
            <li class="layui-nav-item">
                <a href="../memeber/enquiry.html"><i class="iconfont icon-shenhe"></i>&nbsp;查定履歴</a>
            </li>
            <li class="layui-nav-item">
                <a href="../memeber/profile.html"><i class="iconfont icon-setup"></i>&nbsp;会員情報</a>
            </li>
            <li class="layui-nav-item">
                <a href="../memeber/car.html"><i class="iconfont icon-caigou-xianxing"></i>&nbsp;カート</a>
            </li>
        </ul>
        <div class="site-tree-mobile layui-hide">
            <i class="layui-icon">&#xe602;</i>
        </div>
        <div class="site-mobile-shade"></div>
        <div class="site-tree-mobile layui-hide">
            <i class="layui-icon">&#xe602;</i>
        </div>
        <div class="site-mobile-shade"></div>
        <div class="fly-panel fly-panel-user" pad20 style="padding-top:20px;">
            <style>
                .layui-laydate .layui-this {
                    background-color: #a8b6cb !important;
                }

                .layui-form-select dl dd.layui-this {
                    background-color: #a8b6cb !important;
                }

                .layui-laypage .layui-laypage-curr .layui-laypage-em {
                    background-color: #DBE1EA;
                }

                .layui-form-checked[lay-skin=primary] i {
                    background-color: #a8b6cb;
                }

                .layui-btn-now {
                    background: #8ac5e7;
                }

                .layui-btn-now1 {
                    background-color: #84aeed;
                }

                .layui-nav .layui-nav-item a {
                    color: #000;
                }

                .layui-nav .layui-nav-item a:hover,
                .layui-nav .layui-this a {
                    color: #000;
                    text-decoration: none;
                }

                .memeberlogo {
                    width: 30%;
                }

                .layui-tab-brief>.layui-tab-title .layui-this {
                    color: #728EB7;
                }

                .layui-tab-brief>.layui-tab-more li.layui-this:after,
                .layui-tab-brief>.layui-tab-title .layui-this:after {
                    border-bottom: 2px solid rgba(0, 0, 0, 0.3);
                }
            </style>
            <div class="layui-tab layui-tab-brief" lay-filter="user">
                <ul class="layui-tab-title" id="LAY_mine">
                    <li class="layui-this">来店待</li>
                    <li>来店済</li>
                    <li>引き取り終了</li>
                </ul>
                <div class="layui-tab-content" style="padding: 20px 0;">

                    <div class="layui-tab-item layui-show">

                        <table class="layui-table" lay-filter="rules" id="rules">
                        </table>

                    </div>

                    <div class="layui-tab-item">
                        <table class="layui-table" lay-filter="rules2" id="rules2">
                        </table>
                    </div>

                    <div class="layui-tab-item">
                        <table class="layui-table" lay-filter="rules2" id="rules3">
                        </table>
                    </div>

                </div>
            </div>

            <!-- 订单明细详情modal -->
            <div class="modal fade" id="orderDetailModal" tabindex="-1" role="dialog"
                aria-labelledby="orderDetailModalLabel" style="z-index: 10000;">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                                    aria-hidden="true">&times;</span></button>
                            <h4 class="modal-title" id="orderDetailModalLabel">オーダー情報</h4>
                        </div>
                        <div class="modal-body">
                            <!-- 订单明细数据 -->

                            <div class="order_detail">

                            </div>

                            <div class="order_list">

                                <table class="table table-condensed">
                                    <caption style="font-weight: bold;font-size: 16px;">商品明細</caption>
                                    <thead>
                                        <tr>
                                            <th>商品名</th>
                                            <th>品番</th>
                                            <th>サイズ</th>
                                            <th>価格</th>
                                            <th>数量</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                    </tbody>
                                </table>

                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">閉じ</button>
                        </div>
                    </div>
                </div>
            </div>

            <style type="text/css">
                .layui-table-cell {
                    height: auto !important;
                    white-space: normal;
                    text-align: center;
                }

                .layui-btn+.layui-btn {
                    margin-left: 0px;
                }

                .control-label {
                    width: 80px;
                    /*text-align: */
                }

                .layui-none {
                    width: 100% !important;
                }
            </style>

            <script type="text/javascript">
                let user = sessionStorage.getItem('user')
                user = JSON.parse(user)
                $('#avatar').attr('src', user.avatar)
                $('#username').html(user.username)
                //生成买取书
                function buyBook(obj) {
                    var orderid = $(obj).attr('data-whatever');
                    layui.use(['layer'], function () {
                        layer = layui.layer
                        var index = layer.load(1, {
                            shade: [0.4, '#D1D1D1'] //0.1透明度的白色背景
                        });
                        var winRef = window.open("", "_blank");//打开一个新的页面
                        $.post("/member/content/getBuyBooks", { "orderid": orderid }, function (data) {
                            // console.log(data)
                            if (data.code == 0) {
                                layer.closeAll("loading");
                                var ll = window.location.protocol + "//" + window.location.host + data.data;
                                console.log(ll);
                                winRef.location = ll;
                                // window.open(data.data, '_blank');
                            } else {
                                layer.msg(data.msg);
                                layer.closeAll("loading");
                            }
                        }, "json");
                    })
                }
                // 取消预约
                $(document).on('click', '.layui-tr-del2', function () {
                    var that = $(this),
                        href = !that.attr('data-href') ? that.attr('href') : that.attr('data-href');
                    layer.confirm('買取依頼キャンセルします？', { icon: 3, title: 'メッセージ', btn: ['確定', 'マイページ'] }, function (index) {
                        if (!href) {
                            layer.msg('请设置data-href参数');
                            return false;
                        }
                        $.get(href, function (res) {
                            if (res.code == 0) {
                                layer.msg(res.msg);
                            } else {
                                that.parents('tr').remove();
                            }
                        });
                        layer.close(index);
                    });
                    return false;
                });
                layui.use('table', function () {
                    var table = layui.table;
                    // 待到店
                    table.render({
                        elem: '#rules',
                        url: baseUrl + '/api/orderList' //数据接口
                        , where: { order_type: 1, status: 1 } //如果无需传递额外参数，可不加该参数
                        , method: 'get'
                        , headers: { 'Authorization': sessionStorage.getItem('token') }
                        , text: {
                            none: 'オーダー0' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
                        },
                        cols: [[ //表头
                            // {field: 'goodsimage', title: '商品写真', width:120, templet: '<div><img src="__UPLOAD__/{{ d.path }}"></div>'},
                            { field: 'order_num', title: 'オーダー番号', width: 180 },
                            // {field: 'goodsname', title: '商品名称', width:80} ,
                            // {field: 'itemno', title: '货号', width:80} ,
                            // {field: 'size', title: 'サイズ', width:70, sort: true} ,
                            // {field: 'price', title: '価格', width:70, sort: true} ,
                            { field: 'status', title: '状態', width: 80 },
                            // {field: 'createtime', title: '下单时间', width:120, sort: true} ,
                            { field: 'createtime', title: '来店残り時間', width: 120, templet: '<div><dd title="请在有效时长内填写物流编号" style="cursor:pointer" id="timer{{ d.id }}" class="timer" data="{{ d.createtime }}" shoptime="{{ d.shoptime }}" orderId = "{{ d.id }}"></dd></div>' },
                            { field: 'shoptime', title: '予約時間', width: 120, sort: true },
                            { field: 'num', title: '数量', width: 120, sort: true },
                            { field: 'shop_name', title: '店', width: 120, sort: true },
                            { field: 'number', title: '詳細', width: 150, toolbar: '#barTool' },
                        ]],
                        parseData: function (res) { //res 即为原始返回的数据
                            console.log(res)
                            return {
                                "code": 0, //解析接口状态
                                "msg": res.msg, //解析提示文本
                                "count": res.data.total, //解析数据长度
                                "data": res.data.data //解析数据列表
                            }
                        }
                    });
                    //监听单元格编辑
                    layui.use(['layer'], function () {
                        layer = layui.layer
                        table.on('edit(rules)', function (obj) {
                            var value = obj.value //得到修改后的值
                                , data = obj.data //得到所在行所有键值
                                , field = obj.field; //得到字段
                            // layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
                            var serialnum = value;
                            var orderid = data.id;
                            $.post("/member/content/saveSerialNum", { "serialnum": serialnum, "orderid": orderid }, function (data) {
                                layer.msg(data.msg);
                            }, "json");
                        });
                    });
                    // 已到店
                    table.render({
                        elem: '#rules2',
                        url: baseUrl + '/api/orderList' //数据接口
                        , where: { order_type: 1, status: 2 } //如果无需传递额外参数，可不加该参数
                        , method: 'get'
                        , headers: { 'Authorization': sessionStorage.getItem('token') }
                        , text: {
                            none: 'オーダー0' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
                        },
                        cols: [[ //表头
                            // {field: 'goodsimage', title: '商品写真', width:120, templet: '<div><img src="__UPLOAD__/{{ d.path }}"></div>'},
                            { field: 'order_num', title: 'オーダー番号', width: 180 },
                            // {field: 'goodsname', title: '商品名称', width:80} ,
                            // {field: 'itemno', title: '货号', width:80} ,
                            // {field: 'size', title: 'サイズ', width:70, sort: true} ,
                            // {field: 'price', title: '価格', width:70, sort: true} ,
                            { field: 'status', title: '状態', width: 80 },
                            { field: 'createtime', title: '注文時間', width: 120, sort: true },
                            { field: 'shoptime', title: '予約時間', width: 120, sort: true },
                            { field: 'number', title: '詳細', width: 100, toolbar: '#barTool' },
                        ]],
                        parseData: function (res) { //res 即为原始返回的数据
                            console.log(res)
                            return {
                                "code": 0, //解析接口状态
                                "msg": res.msg, //解析提示文本
                                "count": res.data.total, //解析数据长度
                                "data": res.data.data //解析数据列表
                            }
                        }
                    });
                    // 交易閉じ
                    table.render({
                        elem: '#rules3',
                        url: baseUrl + '/api/orderList' //数据接口
                        , where: { order_type: 1, status: 8 } //如果无需传递额外参数，可不加该参数
                        , method: 'get'
                        , headers: { 'Authorization': sessionStorage.getItem('token') }
                        , text: {
                            none: 'オーダー0' //默认：无数据。注：该属性为 layui 2.2.5 开始新增
                        },
                        cols: [[
                            { field: 'order_num', title: 'オーダー番号' },
                            {
                                field: 'status', title: '状態', templet: function (d) {
                                    if (d.overdue == 1) {
                                        return '来店予約時間切れ';
                                    } else {
                                        return d.status;
                                    }
                                }
                            },
                            { field: 'createtime', title: '注文時間', sort: true },
                            { field: 'shoptime', title: '予約時間', sort: true },
                            { field: 'number', title: '詳細', toolbar: '#barTool' },
                        ]],
                        parseData: function (res) { //res 即为原始返回的数据
                            console.log(res)
                            return {
                                "code": 0, //解析接口状态
                                "msg": res.msg, //解析提示文本
                                "count": res.data.total, //解析数据长度
                                "data": res.data.data //解析数据列表
                            }
                        }
                    });
                    //监听单元格编辑
                    layui.use(['layer'], function () {
                        layer = layui.layer
                        table.on('edit(rules2)', function (obj) {
                            var value = obj.value //得到修改后的值
                                , data = obj.data //得到所在行所有键值
                                , field = obj.field; //得到字段
                            // layer.msg('[ID: '+ data.id +'] ' + field + ' 字段更改为：'+ value);
                            var serialnum = value;
                            var orderid = data.id;
                            $.post("/member/content/saveSerialNum", { "serialnum": serialnum, "orderid": orderid }, function (data) {
                                layer.msg(data.msg);
                            }, "json");
                        });
                    });
                });
                $(function () {
                    layui.use(['util', 'laydate', 'layer', 'table'], function () {
                        layer = layui.layer
                        var util = layui.util
                            , laydate = layui.laydate
                            , layer = layui.layer;
                        // 获取订单详细信息
                        // modal
                        $('#orderDetailModal').on('show.bs.modal', function (event) {
                            var button = $(event.relatedTarget)
                            var orderId = button.data('whatever')
                            var modal = $(this)
                            modal.find('.modal-body').find('.order_detail').html('')
                            modal.find('.modal-body').find('.order_list').find('table').find('tbody').html('')
                            $.post("/member/content/getShopOrderDetail2", { "orderid": orderId }, function (data) {
                                if (data.code == 0) {
                                    modal.find('.modal-body').find('.order_detail').html(data.data1);
                                    modal.find('.modal-body').find('.order_list').find('table').find('tbody').html(data.data);
                                } else {
                                    layer.alert(data.msg, {
                                        icon: 5,
                                        title: "メッセージ",
                                        btn: "確定"
                                    });
                                }
                            }, "json");
                        })
                        // 倒计时
                        var getEleTimer = setInterval(function () {
                            var eleNum = $(".timer").length;
                            if (eleNum != 0) {
                                $(".timer").each(function (index, domEle) {
                                    var createtime = $(this).attr('data').replace(/\-/g, "/");
                                    var shoptime = $(this).attr('shoptime').replace(/\-/g, "/");
                                    var eleId = $(this).attr('id');
                                    // var endTime = new Date(createtime).getTime().valueOf() + 1*60*60*1000;
                                    var endTime = new Date(shoptime).getTime().valueOf();
                                    // var endTime = new Date(endTime);
                                    var orderId = $(this).attr('orderid');
                                    var serverTime = new Date(); //假设为当前服务器时间，这里采用的是本地时间，实际使用一般是取服务端的
                                    //五分钟后取消预约按钮
                                    var endTime_cancel = new Date(createtime).getTime().valueOf() + 5 * 60 * 1000;
                                    //结束时间
                                    var endDate_cancel = new Date(endTime_cancel);
                                    //当前时间
                                    var nowDate_cancel = new Date();
                                    //相差的总秒数
                                    var totalSeconds_cancel = parseInt((endDate_cancel - nowDate_cancel) / 1000);
                                    //天数
                                    var days_cancel = Math.floor(totalSeconds_cancel / (60 * 60 * 24));
                                    //取模（余数）
                                    var modulo_cancel = totalSeconds_cancel % (60 * 60 * 24);
                                    //小时数
                                    var hours_cancel = Math.floor(modulo_cancel / (60 * 60));
                                    modulo_cancel = modulo_cancel % (60 * 60);
                                    //分钟
                                    var minutes_cancel = Math.floor(modulo_cancel / 60);
                                    //秒
                                    var seconds_cancel = modulo_cancel % 60;
                                    if (hours_cancel <= 0 && minutes_cancel <= 0 && seconds_cancel <= 0) {
                                        $('#' + eleId).parent().parent().parent('tr').find('td:eq(4)').find('div').find('.layui-tr-del2').remove();
                                    }
                                    //结束时间
                                    var endDate = new Date(endTime);
                                    //当前时间
                                    var nowDate = new Date();
                                    //相差的总秒数
                                    var totalSeconds = parseInt((endDate - nowDate) / 1000);
                                    //天数
                                    var days = Math.floor(totalSeconds / (60 * 60 * 24));
                                    //取模（余数）
                                    var modulo = totalSeconds % (60 * 60 * 24);
                                    //小时数
                                    var hours = Math.floor(modulo / (60 * 60));
                                    modulo = modulo % (60 * 60);
                                    //分钟
                                    var minutes = Math.floor(modulo / 60);
                                    //秒
                                    var seconds = modulo % 60;
                                    var str = hours + '時間' + minutes + '分' + seconds + '秒';
                                    if (hours <= 0 && minutes <= 0 && seconds <= 0) {
                                        lay('#' + eleId).html('時間切れ引き取り終了');
                                        // 处理过期订单
                                        // console.log(orderId);
                                        $.post("/member/content/orderOverdue", { "orderid": orderId, "shop": true }, function (data) {
                                            if (data.code == 0) {
                                                $('#' + eleId).parent().parent().parent('tr').remove();
                                            } else if (data.code == 2) {
                                                layer.alert(data.msg, {
                                                    icon: 5,
                                                    title: "メッセージ",
                                                    btn: "確定"
                                                });
                                            } else {
                                                // layer.alert(data.msg, {
                                                //     icon: 5,
                                                //     title: "メッセージ",
                                                //     btn: "確定"
                                                // });
                                            }
                                        }, "json");
                                    } else {
                                        lay('#' + eleId).html(str);
                                    }
                                    // util.countdown(endTime, serverTime, function(date, serverTime, timer){
                                    //   var str = date[1] + '時間' +  date[2] + '分' + date[3] + '秒';
                                    //   if (date[1] == 0 && date[2] == 0 && date[3] == 0) {
                                    //     lay('#'+eleId).html('時間切れ引き取り終了');
                                    //     // 处理过期订单
                                    //     // console.log(orderId);
                                    //     $.post("/member/content/orderOverdue", { "orderid": orderId , "shop": true},function(data){
                                    //         if (data.code == 0) {
                                    //           $('#'+eleId).parent().parent().parent('tr').remove();
                                    //         } else if(data.code == 2) {
                                    //             layer.alert(data.msg, {
                                    //                 icon: 5,
                                    //                 title: "メッセージ",
                                    //                 btn: "確定"
                                    //             });
                                    //         } else {
                                    //             layer.alert(data.msg, {
                                    //                 icon: 5,
                                    //                 title: "メッセージ",
                                    //                 btn: "確定"
                                    //             });
                                    //         }
                                    //     }, "json");
                                    //   } else {

                                    //     lay('#'+eleId).html(str);
                                    //   }
                                    //   thisTimer = timer;
                                    // });
                                });
                            } else {
                                clearInterval(getEleTimer)
                            }
                        }, 1000);
                    })
                    $('.layui-input').attr("disabled", true);
                    $('input[type="file"]').attr("disabled", "disabled");
                })
            </script>
        </div>
    </div>
    <div class="fly-footer">
        <p>古物営業許可第305502007435号 </p>
        <p><a href="http://www.beian.miit.gov.cn/" target="_blank">豫ICP备19030271号-1</a> <a href="/"
                target="_blank">the1sneaker</a></p>
    </div>
</body>

</html>